<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: Restruct::Hls::Lock
  
    &mdash; Documentation by YARD 0.9.5
  
</title>

  <link rel="stylesheet" href="../../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "Restruct::Hls::Lock";
  relpath = '../../';
</script>


  <script type="text/javascript" charset="utf-8" src="../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../../class_list.html"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../../_index.html">Index (L)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../Restruct.html" title="Restruct (module)">Restruct</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Hls.html" title="Restruct::Hls (module)">Hls</a></span></span>
     &raquo; 
    <span class="title">Lock</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <iframe id="search_frame" src="../../class_list.html"></iframe>

      <div id="content"><h1>Class: Restruct::Hls::Lock
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName"><span class='object_link'><a href="../Types/Base.html" title="Restruct::Types::Base (class)">Types::Base</a></span></span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next"><span class='object_link'><a href="../Types/Base.html" title="Restruct::Types::Base (class)">Types::Base</a></span></li>
          
            <li class="next">Restruct::Hls::Lock</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  <dl>
      <dt>Includes:</dt>
      <dd><span class='object_link'><a href="../Utils/Coercion.html" title="Restruct::Utils::Coercion (module)">Utils::Coercion</a></span>, <span class='object_link'><a href="../Utils/Scriptable.html" title="Restruct::Utils::Scriptable (module)">Utils::Scriptable</a></span></dd>
  </dl>
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/restruct/hls/lock.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Implementation of a simple binary lock (locked/not locked), with option to
block and wait for the lock. Uses two redis structures: a string for the
lease, and a list for blocking operations.</p>


  </div>
</div>
<div class="tags">
  

  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><span class='object_link'><a href="#acquire-instance_method" title="Restruct::Hls::Lock#acquire (method)">#acquire</a></span></li>
    
      <li><span class='object_link'><a href="#release-instance_method" title="Restruct::Hls::Lock#release (method)">#release</a></span></li>
    
      <li><span class='object_link'><a href="#locked-instance_method" title="Restruct::Hls::Lock#locked (method)">#locked</a></span></li>
    
  </ul>

</div>
  <h2>Constant Summary</h2>
  <dl class="constants">
    
      <dt id="DEFAULT_EXPIRY-constant" class="">DEFAULT_EXPIRY =
        <div class="docstring">
  <div class="discussion">
    
<p>The default expiry on the underlying redis keys, in seconds</p>


  </div>
</div>
<div class="tags">
  

</div>
      </dt>
      <dd><pre class="code"><span class='int'>10</span></pre></dd>
    
      <dt id="DEFAULT_TIMEOUT-constant" class="">DEFAULT_TIMEOUT =
        <div class="docstring">
  <div class="discussion">
    
<p>The default timeout when blocking, in seconds; a nil value means it is
non-blocking</p>


  </div>
</div>
<div class="tags">
  

</div>
      </dt>
      <dd><pre class="code"><span class='kw'>nil</span></pre></dd>
    
  </dl>




  <h2>Instance Attribute Summary <small><a href="#" class="summary_toggle">collapse</a></small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#expiry-instance_method" title="#expiry (instance method)">#<strong>expiry</strong>  &#x21d2; Fixnum </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The expiry of the underlying redis structures in seconds.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#timeout-instance_method" title="#timeout (instance method)">#<strong>timeout</strong>  &#x21d2; Fixnum<sup>?</sup> </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The timeout to wait when attempting to acquire the lock, in seconds.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#token-instance_method" title="#token (instance method)">#<strong>token</strong>  &#x21d2; ::String<sup>?</sup> </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The current token or nil.</p>
</div></span>
  
</li>

    
  </ul>



  
  
  <h3 class="inherited">Attributes inherited from <span class='object_link'><a href="../Types/Base.html" title="Restruct::Types::Base (class)">Types::Base</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../Types/Base.html#key-instance_method" title="Restruct::Types::Base#key (method)">#key</a></span></p>


  
    <h2>
      Lua Scripts
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#acquire_script-instance_method" title="#acquire_script (instance method)">#<strong>acquire_script</strong>(keys = [], argv = [])  &#x21d2; ::String </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The acquire script attempts to set the lease (<a href="1">keys</a>) to the
given token (<a href="1">argv</a>), only if it wasn&#39;t already set.</p>
</div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#acquire-instance_method" title="#acquire (instance method)">#<strong>acquire</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Attempts to acquire the lock.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#blocking%3F-instance_method" title="#blocking? (instance method)">#<strong>blocking?</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Whether or not the lock will block when attempting to acquire it.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">#<strong>initialize</strong>(expiry: DEFAULT_EXPIRY, timeout: DEFAULT_TIMEOUT, **options)  &#x21d2; Lock </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>A new instance of Lock.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#inspectable_attributes-instance_method" title="#inspectable_attributes (instance method)">#<strong>inspectable_attributes</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>:stopdoc: :nocov:.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#locked-instance_method" title="#locked (instance method)">#<strong>locked</strong> { ... } &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Executes the given block if the lock can be acquired.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#release-instance_method" title="#release (instance method)">#<strong>release</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Releases the lock only if the current token is the value of the lease.</p>
</div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="../Utils/Scriptable.html" title="Restruct::Utils::Scriptable (module)">Utils::Scriptable</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../Utils/Scriptable.html#included-class_method" title="Restruct::Utils::Scriptable.included (method)">included</a></span></p>

  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="../Utils/Coercion.html" title="Restruct::Utils::Coercion (module)">Utils::Coercion</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../Utils/Coercion.html#coerce_array-class_method" title="Restruct::Utils::Coercion.coerce_array (method)">coerce_array</a></span>, <span class='object_link'><a href="../Utils/Coercion.html#coerce_bool-class_method" title="Restruct::Utils::Coercion.coerce_bool (method)">coerce_bool</a></span></p>

  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods inherited from <span class='object_link'><a href="../Types/Base.html" title="Restruct::Types::Base (class)">Types::Base</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../Types/Base.html#multi-instance_method" title="Restruct::Types::Base#multi (method)">#multi</a></span>, <span class='object_link'><a href="../Types/Base.html#with-instance_method" title="Restruct::Types::Base#with (method)">#with</a></span></p>

  
  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="../Utils/Inspectable.html" title="Restruct::Utils::Inspectable (module)">Utils::Inspectable</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../Utils/Inspectable.html#inspect-instance_method" title="Restruct::Utils::Inspectable#inspect (method)">#inspect</a></span>, <span class='object_link'><a href="../Utils/Inspectable.html#to_s-instance_method" title="Restruct::Utils::Inspectable#to_s (method)">#to_s</a></span></p>
<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    #<strong>initialize</strong>(expiry: DEFAULT_EXPIRY, timeout: DEFAULT_TIMEOUT, **options)  &#x21d2; <tt><span class='object_link'><a href="" title="Restruct::Hls::Lock (class)">Lock</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns a new instance of Lock</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>expiry</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>In seconds; to prevent infinite locking, each mutex is released after a
certain expiry time</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>timeout</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>In seconds; if &gt; 0, will block for this amount of time when trying to
obtain the lock</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


26
27
28
29
30
31
32
33
34
35
36
37</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/restruct/hls/lock.rb', line 26</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='label'>expiry:</span> <span class='const'>DEFAULT_EXPIRY</span><span class='comma'>,</span> <span class='label'>timeout:</span> <span class='const'>DEFAULT_TIMEOUT</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_options'>options</span><span class='rparen'>)</span>
  <span class='kw'>super</span><span class='lparen'>(</span><span class='op'>**</span><span class='id identifier rubyid_options'>options</span><span class='rparen'>)</span>

  <span class='ivar'>@token</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='ivar'>@expiry</span> <span class='op'>=</span> <span class='id identifier rubyid_expiry'>expiry</span>
  <span class='ivar'>@timeout</span> <span class='op'>=</span> <span class='id identifier rubyid_timeout'>timeout</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>

  <span class='id identifier rubyid_create'>create</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_factory'>factory</span><span class='op'>|</span>
    <span class='ivar'>@lease</span> <span class='op'>=</span> <span class='id identifier rubyid_factory'>factory</span><span class='period'>.</span><span class='id identifier rubyid_string'>string</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>lease</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
    <span class='ivar'>@tokens</span> <span class='op'>=</span> <span class='id identifier rubyid_factory'>factory</span><span class='period'>.</span><span class='id identifier rubyid_list'>list</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>tokens</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>

  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id=""></span>
      <div class="method_details first">
  <h3 class="signature first" id="expiry-instance_method">
  
    #<strong>expiry</strong>  &#x21d2; <tt>Fixnum</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>The expiry of the underlying redis structures in seconds</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Fixnum</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the current value of expiry</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


13
14
15</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/restruct/hls/lock.rb', line 13</span>

<span class='kw'>def</span> <span class='id identifier rubyid_expiry'>expiry</span>
  <span class='ivar'>@expiry</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="timeout-instance_method">
  
    #<strong>timeout</strong>  &#x21d2; <tt>Fixnum</tt><sup>?</sup>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>The timeout to wait when attempting to acquire the lock, in seconds</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Fixnum</tt>, <tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the current value of timeout</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


13
14
15</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/restruct/hls/lock.rb', line 13</span>

<span class='kw'>def</span> <span class='id identifier rubyid_timeout'>timeout</span>
  <span class='ivar'>@timeout</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="token-instance_method">
  
    #<strong>token</strong>  &#x21d2; <tt>::String</tt><sup>?</sup>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>The current token or nil</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>::String</tt>, <tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the current value of token</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


13
14
15</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/restruct/hls/lock.rb', line 13</span>

<span class='kw'>def</span> <span class='id identifier rubyid_token'>token</span>
  <span class='ivar'>@token</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="acquire-instance_method">
  
    #<strong>acquire</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Attempts to acquire the lock. First attempts to grab the lease (a redis
string). If the current token is already the lease token, the lock is
considered acquired. If there is no current lease, then sets it to the
current token. If there is a current lease that is not the current token,
then:</p>

<pre class="code ruby"><code class="ruby">1) If this not a blocking lock (see Lock#blocking?), return false
2) If this is a blocking lock, block and wait for the next token to be pushed on the tokens list
3) If a token was pushed, set it as our token and refresh the expiry</code></pre>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>True if acquired, false otherwise</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


61
62
63
64
65
66
67
68
69
70
71
72
73
74</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/restruct/hls/lock.rb', line 61</span>

<span class='kw'>def</span> <span class='id identifier rubyid_acquire'>acquire</span>
  <span class='id identifier rubyid_acquired'>acquired</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_token'>token</span> <span class='op'>=</span> <span class='id identifier rubyid_non_blocking_acquire'>non_blocking_acquire</span><span class='lparen'>(</span><span class='ivar'>@token</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_token'>token</span> <span class='op'>=</span> <span class='id identifier rubyid_blocking_acquire'>blocking_acquire</span> <span class='kw'>if</span> <span class='id identifier rubyid_token'>token</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_blocking?'>blocking?</span>

  <span class='kw'>unless</span> <span class='id identifier rubyid_token'>token</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='ivar'>@token</span> <span class='op'>=</span> <span class='id identifier rubyid_token'>token</span>
    <span class='comment'># since it was popped from a list, need to update the expiry time of the lease, it could be old
</span>    <span class='ivar'>@lease</span><span class='period'>.</span><span class='id identifier rubyid_expire'>expire</span><span class='lparen'>(</span><span class='ivar'>@expiry</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_blocking?'>blocking?</span>
    <span class='id identifier rubyid_acquired'>acquired</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='kw'>end</span>

  <span class='kw'>return</span> <span class='id identifier rubyid_acquired'>acquired</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="acquire_script-instance_method">
  
    #<strong>acquire_script</strong>(keys = [], argv = [])  &#x21d2; <tt>::String</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>The acquire script attempts to set the lease (<a href="1">keys</a>) to the
given token (<a href="1">argv</a>), only if it wasn&#39;t already set. It
then compares to check if the value of the lease is that of the token, and
if so refreshes the expiry (<a href="2">argv</a>) time of the lease.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>keys</span>
      
      
        <span class='type'>(<tt>Array&lt;(::String)&gt;</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>[]</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>The lease key specifying who owns the mutex at the moment</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>argv</span>
      
      
        <span class='type'>(<tt>Array&lt;(::String, Fixnum)&gt;</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>[]</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>The current token; the expiry time in seconds</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>::String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Returns the token if acquired, nil otherwise.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


104
105
106
107
108
109
110
111
112
113</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/restruct/hls/lock.rb', line 104</span>

<span class='id identifier rubyid_local'>local</span> <span class='id identifier rubyid_token'>token</span> <span class='op'>=</span> <span class='const'>ARGV</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span>
<span class='id identifier rubyid_local'>local</span> <span class='id identifier rubyid_expiry'>expiry</span> <span class='op'>=</span> <span class='id identifier rubyid_tonumber'>tonumber</span><span class='lparen'>(</span><span class='const'>ARGV</span><span class='lbracket'>[</span><span class='int'>2</span><span class='rbracket'>]</span><span class='rparen'>)</span>

<span class='id identifier rubyid_redis'>redis</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>set</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='const'>KEYS</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_token'>token</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>NX</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
<span class='kw'>if</span> <span class='id identifier rubyid_redis'>redis</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>get</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='const'>KEYS</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='rparen'>)</span> <span class='op'>==</span> <span class='id identifier rubyid_token'>token</span> <span class='kw'>then</span>
  <span class='id identifier rubyid_redis'>redis</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>expire</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='const'>KEYS</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_expiry'>expiry</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_token'>token</span>
<span class='kw'>end</span>

<span class='kw'>return</span> <span class='kw'>false</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="blocking?-instance_method">
  
    #<strong>blocking?</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Whether or not the lock will block when attempting to acquire it</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


49
50
51</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/restruct/hls/lock.rb', line 49</span>

<span class='kw'>def</span> <span class='id identifier rubyid_blocking?'>blocking?</span>
  <span class='kw'>return</span> <span class='ivar'>@timeout</span> <span class='op'>&gt;</span> <span class='int'>0</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="inspectable_attributes-instance_method">
  
    #<strong>inspectable_attributes</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>:stopdoc: :nocov:</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


146
147
148</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/restruct/hls/lock.rb', line 146</span>

<span class='kw'>def</span> <span class='id identifier rubyid_inspectable_attributes'>inspectable_attributes</span>
  <span class='kw'>super</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='label'>expiry:</span> <span class='ivar'>@expiry</span><span class='comma'>,</span> <span class='label'>blocking:</span> <span class='id identifier rubyid_blocking?'>blocking?</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="locked-instance_method">
  
    #<strong>locked</strong> { ... } &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Executes the given block if the lock can be acquired</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Yields:</p>
<ul class="yield">
  
    <li>
      
      
        <span class='type'></span>
      
      
      
        
        <div class='inline'>
<p>Block to be executed if the lock is acquired</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


41
42
43
44
45</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/restruct/hls/lock.rb', line 41</span>

<span class='kw'>def</span> <span class='id identifier rubyid_locked'>locked</span>
  <span class='kw'>yield</span> <span class='kw'>if</span> <span class='id identifier rubyid_acquire'>acquire</span>
<span class='kw'>ensure</span>
  <span class='id identifier rubyid_release'>release</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="release-instance_method">
  
    #<strong>release</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Releases the lock only if the current token is the value of the lease. If
the lock is a blocking lock (see Lock#blocking?), push the next token on
the tokens list.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>True if released, false otherwise</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


79
80
81
82
83
84</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/restruct/hls/lock.rb', line 79</span>

<span class='kw'>def</span> <span class='id identifier rubyid_release'>release</span>
  <span class='kw'>return</span> <span class='kw'>false</span> <span class='kw'>if</span> <span class='ivar'>@token</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>

  <span class='id identifier rubyid_next_token'>next_token</span> <span class='op'>=</span> <span class='const'>SecureRandom</span><span class='period'>.</span><span class='id identifier rubyid_uuid'>uuid</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_coerce_bool'>coerce_bool</span><span class='lparen'>(</span><span class='id identifier rubyid_release_script'>release_script</span><span class='lparen'>(</span><span class='label'>keys:</span> <span class='lbracket'>[</span><span class='ivar'>@lease</span><span class='period'>.</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='ivar'>@tokens</span><span class='period'>.</span><span class='id identifier rubyid_key'>key</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>argv:</span> <span class='lbracket'>[</span><span class='ivar'>@token</span><span class='comma'>,</span> <span class='id identifier rubyid_next_token'>next_token</span><span class='comma'>,</span> <span class='ivar'>@expiry</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Mon Aug 29 14:24:07 2016 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.5 (ruby-2.3.1).
</div>

    </div>
  </body>
</html>